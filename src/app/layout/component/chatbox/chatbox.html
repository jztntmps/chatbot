<div
  class="layout"
  [class.layout--no-sidebar]="!isLoggedIn"
  [class.layout--sidebar-closed]="isLoggedIn && !sidebarOpen"
>
  <!-- SIDEBAR -->
  <div class="sidebar-shell" *ngIf="isLoggedIn">
    <app-sidebar
      [isOpen]="sidebarOpen"
      [username]="userEmail"
      [chats]="chats"
      [userId]="userId"
      (toggle)="toggleSidebar()"
      (newChat)="startNewChat()"
      (openChat)="openChat($event)"
      (seeAll)="seeAll()"
      (settings)="openSettings()"
      (archive)="goArchive()"
      (logout)="logout()"
      (deleteChatId)="onDeleteChat($event)"
      (archiveChatId)="onArchiveChat($event)"
      (exportChatId)="onExportChat($event)"
      (refreshChats)="reloadConversations()"
      
    ></app-sidebar>
  </div>

  <!-- RIGHT CONTENT -->
  <main class="chatbox">
    <div class="topbar-shell">
<app-topbar
  [isLoggedIn]="isLoggedIn"
  [messages]="messages"
  [currentConversationId]="activeConversationId"
  (archiveChatId)="onArchiveChat($event)"
  (deleteChatId)="onDeleteChat($event)"
  (exportChat)="exportConversationPdf()"
   (login)="goLogin()"
  (signup)="goSignup()"
></app-topbar>
    </div>

    <section class="chat">
      <div class="chat__header" *ngIf="messages.length === 0">
        <h1 class="headline">Here when you need me.</h1>
        <p class="sub">Type a message and I'll respond.</p>
      </div>

      <div class="chat__messages" role="log" aria-live="polite">
        <div
          class="msg"
          *ngFor="let m of messages; let i = index"
          [class.msg--user]="m.role === 'user'"
          [class.msg--ai]="m.role === 'ai'"
        >
          <!-- AI avatar -->
          <img
            *ngIf="m.role === 'ai'"
            class="msg__avatar"
            src="assets/profile.png"
            alt="Bot"
          />

          <div class="msg__stack">
            <!-- âœ… USER: bubble becomes editor when editing -->
            <ng-container *ngIf="m.role === 'user'; else aiBubble">
              <!-- normal bubble -->
              <ng-container *ngIf="editingIndex !== i; else userEditBubble">
                <div class="msg__bubble">{{ m.text }}</div>

                <div class="msg__actions">
                  <button
                    type="button"
                    class="msg__action"
                    title="Copy"
                    aria-label="Copy message"
                    (click)="copyText(m.text)"
                  >
                    â§‰
                  </button>

                  <button
                    type="button"
                    class="msg__action"
                    title="Edit"
                    aria-label="Edit message"
                    (click)="startEditUserMessage(i)"
                    [disabled]="sending"
                  >
                    âœŽ
                  </button>
                </div>
              </ng-container>

              <!-- edit bubble (inline) -->
              <ng-template #userEditBubble>
                <div class="msg__bubble msg__bubble--editing">
                  <textarea
                    class="bubble__editor"
                    [(ngModel)]="editingText"
                    name="editingText{{ i }}"
                    rows="1"
                    (input)="autoGrow($event)"
                    [disabled]="sending"
                  ></textarea>

                  <div class="bubble__edit-actions">
                    <button
                      type="button"
                      class="bubble__btn"
                      (click)="cancelEdit()"
                      [disabled]="sending"
                    >
                      Cancel
                    </button>

                    <button
                      type="button"
                      class="bubble__btn bubble__btn--primary"
                      (click)="saveEditAndResend()"
                      [disabled]="sending || !editingText.trim()"
                    >
                      Save &amp; Resend
                    </button>
                  </div>
                </div>

                <!-- keep copy icon available while editing -->
                <div class="msg__actions">
                  <button
                    type="button"
                    class="msg__action"
                    title="Copy"
                    aria-label="Copy message"
                    (click)="copyText(editingText || m.text)"
                  >
                    â§‰
                  </button>
                </div>
              </ng-template>
            </ng-container>

            <!-- âœ… AI bubble -->
            <ng-template #aiBubble>
              <div class="msg__bubble">{{ m.text }}</div>
            </ng-template>
          </div>
        </div>

        <div class="typing" *ngIf="sending">
          <div class="typing__bubble">
            <span class="typing__dot"></span>
            <span class="typing__dot"></span>
            <span class="typing__dot"></span>
          </div>
        </div>
      </div>

      <form class="prompt" autocomplete="off" (ngSubmit)="onSubmit()">

        <!-- INPUT WRAPPER -->
        <div class="prompt__field">
          <input
            class="prompt__input"
            type="text"
            name="message"
            placeholder="Ask me anything..."
            [(ngModel)]="message"
          />

          <!-- ðŸŽ¤ MIC INSIDE INPUT -->
          <button
            type="button"
            class="prompt__mic"
            (click)="toggleVoice()"
            [class.prompt__mic--active]="listening"
            aria-label="Voice input"
            title="Voice input"
          >
            <span class="prompt__micIcon" aria-hidden="true">
              <!-- mic icon -->
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0 1 1 0 1 0-2 0 7 7 0 0 0 6 6.92V20H9a1 1 0 1 0 0 2h6a1 1 0 1 0 0-2h-2v-2.08A7 7 0 0 0 19 11a1 1 0 1 0-2 0Z"
                />
              </svg>
            </span>

            <!-- right circle (wave) -->
            <span class="prompt__micWave" aria-hidden="true"></span>
          </button>
        </div>

        <!-- SEND -->
        <button
          *ngIf="!sending"
          class="prompt__send"
          type="submit"
          [disabled]="!message.trim()"
          aria-label="Send"
          title="Send"
        >
          <span class="prompt__arrow">âž¤</span>
        </button>

        <!-- STOP -->
        <button
          *ngIf="sending"
          class="prompt__stop"
          type="button"
          (click)="stopGeneration()"
          aria-label="Stop"
          title="Stop"
        >
          â– 
        </button>

      </form>
    </section>
    <app-footer></app-footer>
  </main>
</div>